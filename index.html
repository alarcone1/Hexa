<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HexaFlow: Strategic Honeycomb</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#020617">
    <link rel="apple-touch-icon" href="icon.png">
    <script>
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            const container = document.getElementById('message-overlay');
            if (container) {
                container.classList.add('active');
                container.style.opacity = 1;
                container.style.fontSize = "12px";
                container.style.textAlign = "left";
                container.style.whiteSpace = "pre-wrap";
                container.innerText = `Error: ${msg}\nLine: ${lineNo}\nFile: ${url}\nError Object: ${error}`;
                console.error("Global Error:", msg, error);
            }
            alert(`Error: ${msg}\n${url}:${lineNo}`);
            return false;
        };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700;800&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="style.css?v=14.0">
</head>

<body>

    <div id="game-container">

        <!-- Barra Lateral de Colores Activos -->
        <div id="active-colors-sidebar">
            <h3>COLORES</h3>
            <div id="active-colors-list"></div>
        </div>

        <div id="hud">
            <!-- Nivel Actual (Ascensi√≥n con Progreso Hexagonal) -->
            <div id="level-indicator">
                <span id="level-title">NIVEL <span class="level-number">1</span></span>
                <div id="level-progress-hexes">
                    <!-- Los 10 hex√°gonos se generar√°n v√≠a JS o estar√°n fijos -->
                    <div class="mini-hex" data-index="1"></div>
                    <div class="mini-hex" data-index="2"></div>
                    <div class="mini-hex" data-index="3"></div>
                    <div class="mini-hex" data-index="4"></div>
                    <div class="mini-hex" data-index="5"></div>
                    <div class="mini-hex" data-index="6"></div>
                    <div class="mini-hex" data-index="7"></div>
                    <div class="mini-hex" data-index="8"></div>
                    <div class="mini-hex" data-index="9"></div>
                    <div class="mini-hex" data-index="10"></div>
                </div>
            </div>

            <!-- Botones de Sistema (Arriba Izquierda) -->
            <div class="hud-buttons">
                <button id="ranking-trigger" class="hud-btn" onclick="showRankingModal()"
                    data-tooltip="Sal√≥n de la Fama">
                    <i data-lucide="trophy"></i>
                </button>
                <button id="config-trigger" class="hud-btn" onclick="toggleConfig()" data-tooltip="Configuraci√≥n">
                    <i data-lucide="settings"></i>
                </button>
                <button id="help-trigger" class="hud-btn" onclick="toggleHelp()" data-tooltip="Ayuda">
                    <i data-lucide="circle-help"></i>
                </button>
                <button id="quick-restart-trigger" class="hud-btn" onclick="newGame()" data-tooltip="Reiniciar">
                    <i data-lucide="rotate-ccw"></i>
                </button>
            </div>
        </div>

        <canvas id="gameCanvas"></canvas>
        <div id="message-overlay"></div>

        <!-- Ranking Flotante ELIMINADO en favor de p√°gina dedicada -->

        <!-- Wrapper para Centrado Sim√©trico -->
        <div id="dashboard-wrapper">
            <!-- Barra de Progreso (Externa pero sim√©trica) -->
            <div id="goal-progress-container">
                <div id="goal-progress-bar">
                    <div id="goal-progress-fill">
                        <span id="goal-progress-label">0%</span>
                    </div>
                </div>
            </div>

            <!-- Barra de Estad√≠sticas -->
            <div id="bottom-stats">
                <div class="stat-item"><span class="stat-label">PUNTOS</span> <span id="score" class="stat-num">0</span>
                </div>
                <div class="stat-item"><span class="stat-label">META</span> <span id="goal" class="stat-num">100</span>
                </div>
                <div class="stat-item"><span class="stat-label">MOV</span> <span id="moves-count"
                        class="stat-num">0</span>
                </div>
            </div>
        </div>

        <div id="controls">
            <div id="pile-0" class="pile-slot" onclick="selectPile(0)"></div>
            <div id="pile-1" class="pile-slot" onclick="selectPile(1)"></div>
            <div id="pile-2" class="pile-slot" onclick="selectPile(2)"></div>
            <button id="mulligan-btn" class="btn btn--gold" onclick="mulligan()">
                <span class="btn-icon"><i data-lucide="shuffle"></i></span> Otra Tanda (<span
                    id="mulligan-count">3</span>)
            </button>
        </div>

        <!-- Intelligence Bar (Status Bar) -->
        <div id="intelligence-bar">
            <div id="intel-content">
                <i data-lucide="info" class="intel-icon"></i>
                <span id="intel-text">Prep√°rate para la Ascensi√≥n...</span>
            </div>
        </div>

        <!-- FLASHCARD DE NIVEL (Overlay) -->
        <div id="level-flashcard" class="flashcard-overlay">
            <div class="flashcard-content advanced-panel">
                <div class="flashcard-header">
                    <i data-lucide="sparkles" class="flash-icon-main"></i>
                    <h1 id="flash-level-title">NIVEL 1</h1>
                </div>
                <div class="flashcard-body">
                    <div id="flash-obstacle-preview" class="obstacle-preview"></div>
                    <h3 id="flash-obstacle-name">EL COMIENZO</h3>
                    <p id="flash-obstacle-desc">Domina el flujo b√°sico antes de enfrentar los desaf√≠os de la Ascensi√≥n.
                    </p>
                </div>
                <button class="btn btn--gold" onclick="closeFlashcard()">
                    <i data-lucide="play"></i> COMIENZO DE TRANSMISI√ìN
                </button>
            </div>
        </div>

        <!-- MODAL DE AYUDA -->
        <div id="help-modal">
            <div class="help-content advanced-panel">
                <h2>
                    <i data-lucide="book-open" class="config-icon-title"></i>
                    GU√çA T√ÅCTICA
                </h2>

                <div class="config-grid">
                    <!-- Columna 1: Lo B√°sico -->
                    <div class="config-column">
                        <div class="config-card">
                            <h3><i data-lucide="target"></i> Objetivo</h3>
                            <p>Completa el nivel alcanzando la meta de puntos con la <b>mayor eficiencia posible</b>.
                            </p>
                            <p class="config-desc-small">El √©xito se mide por la precisi√≥n, no por la velocidad pura.
                            </p>
                        </div>

                        <div class="config-card">
                            <h3><i data-lucide="zap"></i> Mec√°nica de Flujo</h3>
                            <p>Al colocar una pila, las fichas saltan a vac√≠os vecinos del mismo color hacia la pila m√°s
                                alta.</p>
                            <p class="config-desc-small">Domina el flujo para crear cascadas masivas de puntos.</p>
                        </div>

                        <div class="config-card">
                            <h3><i data-lucide="gamepad-2"></i> Controles</h3>
                            <ul class="clean-list">
                                <li><b>Click:</b> Colocar pila seleccionada.</li>
                                <li><b>Flechas / WASD:</b> Rotar tablero.</li>
                                <li><b>Mulligan:</b> Recibir nuevas piezas.</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Columna 2: Estrategia Avanzada -->
                    <div class="help-column config-column">
                        <div class="config-card">
                            <h3><i data-lucide="award"></i> Ranking Maestro</h3>
                            <p>La puntuaci√≥n suprema se logra con:</p>
                            <ol style="margin-top: 0; padding-left: 20px;">
                                <li><b>Menos Pilas:</b> Bonus de precisi√≥n.</li>
                                <li><b>Menor tiempo:</b> Bonus de velocidad.</li>
                            </ol>
                        </div>

                        <div class="config-card">
                            <h3><i data-lucide="brain-circuit"></i> Ayuda T√°ctica</h3>
                            <p>Configura el <b>Nivel de Amistad</b> y la <b>Inteligencia IA</b> en el Centro de Control
                                para recibir apoyo.</p>
                            <p class="config-desc-small">Usa la IA a tu favor para desbloquear situaciones cr√≠ticas.</p>
                        </div>

                        <div class="config-card">
                            <h3><i data-lucide="maximize"></i> Tama√±o y Desaf√≠o</h3>
                            <p>Elige entre un tablero peque√±o din√°mico o uno grande estrat√©gico.</p>
                            <p class="config-desc-small">Cada radio cambia radicalmente el flujo de fichas.</p>
                        </div>
                    </div>
                </div>

                <div class="modal-buttons config-actions">
                    <a href="manual.html" class="btn btn--primary"
                        style="text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                        <i data-lucide="book-open-check"></i>
                        VER MANUAL COMPLETO
                    </a>
                    <button id="close-help-btn" class="btn btn--gold" onclick="toggleHelp()">
                        <i data-lucide="check"></i>
                        APLICAR Y CERRAR
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL DE VICTORIA -->
        <div id="gameover-modal">
            <div class="gameover-content">
                <h2 id="modal-title">
                    <i data-lucide="party-popper" class="config-icon-title"></i>
                    ¬°NIVEL COMPLETADO!
                </h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-value" id="final-moves">0</span>
                        <span class="stat-label">
                            <i data-lucide="layers" class="stat-icon"></i>
                            Pilas Usadas
                        </span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="final-time">0:00</span>
                        <span class="stat-label">
                            <i data-lucide="clock" class="stat-icon"></i>
                            Tiempo
                        </span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="best-combo">0</span>
                        <span class="stat-label">
                            <i data-lucide="zap" class="stat-icon"></i>
                            Mejor Combo
                        </span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="total-eliminated">0</span>
                        <span class="stat-label">
                            <i data-lucide="hexagon" class="stat-icon"></i>
                            Eliminadas
                        </span>
                    </div>
                </div>
                <!-- <div id="new-record" style="display: none;">üèÜ ¬°NUEVO RECORD!</div> -->
                <div class="modal-buttons">
                    <button id="restart-btn" class="btn btn--primary" onclick="restartGame()">
                        <i data-lucide="gamepad-2"></i>
                        NUEVO JUEGO
                    </button>
                    <button id="ranking-btn" class="btn btn--gold" onclick="showRankingFromModal()">
                        <i data-lucide="trophy"></i>
                        VER RANKING
                    </button>
                </div>
            </div>
        </div>

        <!-- P√ÅGINA DE RANKING -->
        <div id="ranking-modal">
            <div class="ranking-content">
                <h2>
                    <i data-lucide="trophy" class="config-icon-title"></i>
                    SAL√ìN DE LA FAMA
                </h2>

                <h3 style="text-align: center; color: var(--color-gold); margin-bottom: 10px; font-size: 1rem;">Tama√±o
                    del Tablero</h3>
                <div class="difficulty-segmented-control" style="margin-bottom: 20px;">
                    <button class="segment-btn ranking-filter" data-difficulty="3"
                        onclick="showRankingModal(3)">Peque√±o</button>
                    <button class="segment-btn ranking-filter active" data-difficulty="4"
                        onclick="showRankingModal(4)">Normal</button>
                    <button class="segment-btn ranking-filter" data-difficulty="5"
                        onclick="showRankingModal(5)">Grande</button>
                </div>

                <div id="ranking-header-container"></div>

                <div class="ranking-table-header">
                    <span>#</span>
                    <span>NIVEL</span>
                    <span>PILAS</span>
                    <span>TIEMPO</span>
                    <span>FECHA</span>
                    <span>HORA</span>
                </div>
                <div id="full-scores-list"></div>

                <div style="display: flex; justify-content: center; margin-top: 20px;">
                    <button class="close-ranking-btn btn btn--gold-outline" onclick="closeRanking()">
                        <i data-lucide="house"></i>
                        VOLVER
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL DE CONFIRMACI√ìN DE REINICIO -->
        <div id="reset-confirm-modal">
            <div class="reset-confirm-content">
                <h2><i data-lucide="alert-triangle"></i> ¬øReiniciar desde cero?</h2>
                <p>Esto borrar√°:</p>
                <ul>
                    <li>‚Ä¢ Todo el progreso de niveles</li>
                    <li>‚Ä¢ Configuraci√≥n guardada</li>
                    <li>‚Ä¢ Ranking de puntuaciones</li>
                </ul>
                <p class="reset-warning">El juego volver√° al Nivel 1, Sub-nivel 1.</p>
                <div class="reset-confirm-actions">
                    <button class="btn btn--gold-outline" onclick="closeResetConfirm()">
                        <i data-lucide="x"></i>
                        CANCELAR
                    </button>
                    <button class="btn btn--danger" onclick="executeReset()">
                        <i data-lucide="trash-2"></i>
                        CONFIRMAR REINICIO
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL DE CONFIGURACI√ìN -->
        <div id="config-modal">
            <div class="config-content advanced-panel">
                <h2>
                    <i data-lucide="settings-2" class="config-icon-title"></i>
                    CENTRO DE CONTROL
                </h2>

                <div class="config-grid">
                    <!-- Columna 1: Dificultad Base -->
                    <div class="config-column">
                        <div class="config-card">
                            <h3><i data-lucide="layout-grid"></i> Tama√±o de Tablero</h3>
                            <div class="difficulty-segmented-control">
                                <button class="segment-btn" data-difficulty="3"
                                    onclick="setDifficulty(3)">Peque√±o</button>
                                <button class="segment-btn" data-difficulty="4"
                                    onclick="setDifficulty(4)">Normal</button>
                                <button class="segment-btn active" data-difficulty="5"
                                    onclick="setDifficulty(5)">Grande</button>
                            </div>
                            <div id="difficulty-description" class="config-desc-small">Radio 5 ‚Ä¢ 91 celdas</div>
                        </div>

                        <div class="config-card">
                            <h3><i data-lucide="target"></i> Meta de Puntos</h3>
                            <div class="height-slider-container">
                                <input type="range" id="goal-range" min="10" max="200" step="10" value="200"
                                    onchange="setGoal(this.value)" oninput="updateGoalLabel(this.value)">
                                <div class="slider-value"><span id="goal-label">200</span></div>
                            </div>
                            <p class="config-desc-small">Puntos necesarios para completar el nivel actual.</p>
                        </div>

                        <div class="config-card">
                            <h3><i data-lucide="bar-chart-3"></i> L√≠mite de Altura</h3>
                            <div class="height-slider-container">
                                <input type="range" id="height-range" min="5" max="30" value="15"
                                    onchange="setMaxHeight(this.value)" oninput="updateHeightLabel(this.value)">
                                <div class="slider-value"><span id="height-label">15</span></div>
                            </div>
                            <p class="config-desc-small">Fichas m√°ximas permitidas antes de bloquear la celda.</p>
                        </div>
                    </div>

                    <!-- Columna 2: Amistad e Inteligencia -->
                    <div class="config-column">
                        <div class="config-card">
                            <h3><i data-lucide="heart-handshake"></i> Nivel de Amistad</h3>
                            <div class="height-slider-container">
                                <input type="range" id="friendship-range" min="0" max="100" value="40"
                                    onchange="setFriendship(this.value)" oninput="updateFriendshipLabel(this.value)">
                                <div class="slider-value"><span id="friendship-label">40</span>%</div>
                            </div>
                            <p class="config-desc-small">Umbral de ocupaci√≥n para recibir ayuda t√°ctica</p>
                        </div>

                        <div class="config-card">
                            <h3><i data-lucide="brain-circuit"></i> Inteligencia IA</h3>
                            <div class="height-slider-container">
                                <input type="range" id="reveal-range" min="0" max="300" step="10" value="150"
                                    onchange="setRevealBonus(this.value)" oninput="updateRevealLabel(this.value)">
                                <div class="slider-value"><span id="reveal-label">150 pts</span></div>
                            </div>
                            <p class="config-desc-small">Puntos extra que la IA valora al revelarte nuevas jugadas.</p>
                        </div>

                        <div class="config-card">
                            <h3><i data-lucide="eye"></i> Anticipaci√≥n</h3>
                            <div class="height-slider-container">
                                <input type="range" id="analysis-range" min="1" max="15" value="5"
                                    onchange="setAnalysisHeight(this.value)" oninput="updateAnalysisLabel(this.value)">
                                <div class="slider-value"><span id="analysis-label">5</span></div>
                            </div>
                            <p class="config-desc-small">Altura m√≠nima para predecir tus necesidades</p>
                        </div>
                    </div>
                </div>

                <div class="config-actions">
                    <button class="btn btn--gold-outline" onclick="toggleConfig()">
                        <i data-lucide="house"></i>
                        VOLVER
                    </button>
                    <button id="cancel-config-btn" class="btn btn--gold" onclick="toggleConfig()">
                        <i data-lucide="check"></i>
                        APLICAR CAMBIOS
                    </button>
                    <button id="reset-data-btn" class="btn btn--danger-outline" onclick="resetRankingsConfirm(event)">
                        <i data-lucide="trash-2"></i>
                        REINICIAR TODO
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="js/main.js?v=14.0"></script>
    <script>
        lucide.createIcons();

        // Registro de Service Worker (Desactivado temporalmente por incompa        d e        ost)
        /*
        if ('service            avigator) {
            window.addEventL                () => {
                navigator.serviceWor                    s')
                    .then(reg => consol                    '))
                    .catch(err => console            or',                    }          */
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HexaFlow: Strategic Honeycomb</title>
    <script>
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            const container = document.getElementById('message-overlay');
            if (container) {
                container.style.opacity = 1;
                container.style.fontSize = "12px";
                container.style.textAlign = "left";
                container.style.whiteSpace = "pre-wrap";
                container.innerText = `Error: ${msg}\nLine: ${lineNo}\nFile: ${url}\nError Object: ${error}`;
                console.error("Global Error:", msg, error);
            }
            alert(`Error: ${msg}\n${url}:${lineNo}`);
            return false;
        };
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div id="game-container">

        <!-- Barra Lateral de Colores Activos -->
        <div id="active-colors-sidebar">
            <h3>COLORES</h3>
            <div id="active-colors-list"></div>
        </div>

        <div id="hud">
            <!-- Botones de Sistema (Arriba Izquierda) -->
            <div class="hud-buttons">
                <button id="ranking-trigger" class="hud-btn" onclick="showRankingModal()"
                    data-tooltip="Sal√≥n de la Fama">
                    <i data-lucide="trophy"></i>
                </button>
                <button id="config-trigger" class="hud-btn" onclick="toggleConfig()" data-tooltip="Configuraci√≥n">
                    <i data-lucide="settings"></i>
                </button>
                <button id="help-trigger" class="hud-btn" onclick="toggleHelp()" data-tooltip="Ayuda">
                    <i data-lucide="circle-help"></i>
                </button>
                <button id="quick-restart-trigger" class="hud-btn" onclick="newGame()" data-tooltip="Reiniciar">
                    <i data-lucide="rotate-ccw"></i>
                </button>
            </div>
        </div>

        <canvas id="gameCanvas"></canvas>
        <div id="message-overlay"></div>

        <!-- Ranking Flotante ELIMINADO en favor de p√°gina dedicada -->

        <!-- Barra de Estad√≠sticas (Ahora encima de los controles) -->
        <div id="bottom-stats">
            <div class="stat-item"><span class="stat-label">PUNTOS</span> <span id="score" class="stat-num">0</span>
            </div>
            <div class="stat-item"><span class="stat-label">META</span> <span id="goal" class="stat-num">100</span>
            </div>
            <div class="stat-item"><span class="stat-label">MOV</span> <span id="moves-count" class="stat-num">0</span>
            </div>
        </div>

        <div id="controls">
            <div id="pile-0" class="pile-slot" onclick="selectPile(0)"></div>
            <div id="pile-1" class="pile-slot" onclick="selectPile(1)"></div>
            <div id="pile-2" class="pile-slot" onclick="selectPile(2)"></div>
            <button id="mulligan-btn" onclick="mulligan()">
                <span class="btn-icon"><i data-lucide="shuffle"></i></span> Otra Tanda (<span
                    id="mulligan-count">3</span>)
            </button>
        </div>

        <!-- MODAL DE AYUDA -->
        <div id="help-modal">
            <div class="help-content">
                <h2>
                    <i data-lucide="book-open"
                        style="width: 1.2em; height: 1.2em; vertical-align: bottom; margin-right: 8px;"></i>
                    C√≥mo Jugar HexaFlow
                </h2>

                <div class="help-section">
                    <h3>Objetivo</h3>
                    <p>Completa el nivel alcanzando la meta de puntos con la <b>mayor eficiencia posible</b>.</p>
                    <p>Tu ranking depender√° de:</p>
                    <ol>
                        <li><b>Menor n√∫mero de Pilas usadas</b> (Prioridad 1)</li>
                        <li><b>Menor tiempo</b> (Prioridad 2)</li>
                    </ol>
                </div>

                <div class="help-section">
                    <h3>Mec√°nica de Flujo</h3>
                    <p>Cuando colocas una pila, las fichas "saltan" hacia pilas vecinas del mismo color dominante.
                        ¬°Usa
                        esto para crear reacciones en cadena y ahorrar movimientos!</p>
                </div>

                <div class="help-section">
                    <h3>Controles</h3>
                    <p>‚Ä¢ <b>Click:</b> Selecciona pila y col√≥cala en el tablero.</p>
                    <p>‚Ä¢ <b>Flechas (Mantener):</b> Rota el tablero suavemente.</p>
                    <p>‚Ä¢ <b>Mulligan:</b> Genera nuevas fichas (limitado).</p>
                </div>

                <button id="close-help-btn" onclick="toggleHelp()">ENTENDIDO</button>
            </div>
        </div>

        <!-- MODAL DE VICTORIA -->
        <div id="gameover-modal">
            <div class="gameover-content">
                <h2 id="modal-title">üèÜ ¬°NIVEL COMPLETADO!</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-value" id="final-moves">0</span>
                        <span class="stat-label">
                            <i data-lucide="layers" class="stat-icon"></i>
                            Pilas Usadas
                        </span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="final-time">0:00</span>
                        <span class="stat-label">
                            <i data-lucide="clock" class="stat-icon"></i>
                            Tiempo
                        </span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="best-combo">0</span>
                        <span class="stat-label">
                            <i data-lucide="zap" class="stat-icon"></i>
                            Mejor Combo
                        </span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="total-eliminated">0</span>
                        <span class="stat-label">
                            <i data-lucide="hexagon" class="stat-icon"></i>
                            Eliminadas
                        </span>
                    </div>
                </div>
                <!-- <div id="new-record" style="display: none;">üèÜ ¬°NUEVO RECORD!</div> -->
                <div class="modal-buttons">
                    <button id="restart-btn" onclick="restartGame()">
                        <i data-lucide="gamepad-2"></i>
                        NUEVO JUEGO
                    </button>
                    <button id="ranking-btn" onclick="showRankingFromModal()">
                        <i data-lucide="trophy"></i>
                        VER RANKING
                    </button>
                </div>
            </div>
        </div>

        <!-- P√ÅGINA DE RANKING -->
        <div id="ranking-modal">
            <div class="ranking-content">
                <h2>SAL√ìN DE LA FAMA</h2>

                <div class="difficulty-segmented-control" style="margin-bottom: 20px;">
                    <button class="segment-btn ranking-filter" data-difficulty="2"
                        onclick="showRankingModal(2)">F√°cil</button>
                    <button class="segment-btn ranking-filter active" data-difficulty="3"
                        onclick="showRankingModal(3)">Normal</button>
                    <button class="segment-btn ranking-filter" data-difficulty="4"
                        onclick="showRankingModal(4)">Dif√≠cil</button>
                </div>

                <div id="ranking-header-container"></div>

                <div class="ranking-table-header">
                    <span>#</span>
                    <span>Pilas</span>
                    <span>Tiempo</span>
                    <span>Fecha</span>
                    <span>Hora</span>
                </div>
                <div id="full-scores-list"></div>

                <div style="display: flex; justify-content: center; margin-top: 20px;">
                    <button class="close-ranking-btn" onclick="closeRanking()">
                        <i data-lucide="house"
                            style="width: 1.2em; height: 1.2em; display: inline-block; vertical-align: middle; margin-right: 5px;"></i>
                        VOLVER
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL DE CONFIGURACI√ìN -->
        <div id="config-modal">
            <div class="config-content">
                <h2>
                    <i data-lucide="settings" class="config-icon-large"></i>
                    CONFIGURACI√ìN
                </h2>

                <div class="config-card">
                    <h3>Nivel de Dificultad</h3>

                    <div class="difficulty-segmented-control">
                        <button class="segment-btn" data-difficulty="2" onclick="setDifficulty(2)">F√°cil</button>
                        <button class="segment-btn active" data-difficulty="3"
                            onclick="setDifficulty(3)">Normal</button>
                        <button class="segment-btn" data-difficulty="4" onclick="setDifficulty(4)">Dif√≠cil</button>
                    </div>
                    <div id="difficulty-description" class="config-desc-small">Radio 3 ‚Ä¢ 37 celdas</div>
                </div>

                <div class="config-card">
                    <h3>Meta de Puntos</h3>
                    <div class="height-slider-container">
                        <input type="range" id="goal-range" min="50" max="500" step="10" value="100"
                            onchange="setGoal(this.value)" oninput="updateGoalLabel(this.value)">
                        <div class="slider-value"><span id="goal-label">100</span></div>
                    </div>
                    <p class="config-desc-small">Puntos para completar el nivel</p>
                </div>

                <div class="config-card">
                    <h3>L√≠mite de Altura</h3>
                    <div class="height-slider-container">
                        <input type="range" id="height-range" min="10" max="30" value="15"
                            onchange="setMaxHeight(this.value)" oninput="updateHeightLabel(this.value)">
                        <div class="slider-value"><span id="height-label">15</span> fichas</div>
                    </div>
                    <p class="config-desc-small">M√°ximo de fichas por celda</p>
                </div>

                <div class="config-actions">
                    <button id="cancel-config-btn" onclick="toggleConfig()">Cerrar</button>
                </div>

                <div class="danger-zone-link">
                    <a href="#" onclick="resetRankingsConfirm(); return false;">‚ö†Ô∏è Resetear Rankings Data</a>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="js/main.js"></script>
    <script>
        lucide.createIcons();
    </script>
</body>

</html>